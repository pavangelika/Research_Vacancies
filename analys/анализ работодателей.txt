WITH base AS (
    SELECT
        COALESCE(NULLIF(v.professional_role, ''), 'UNKNOWN_ROLE') AS professional_role,
        date_trunc('month', v.published_at)::date AS month_start,
        v.currency,
        v.has_test,
        v.response_letter_required,
        COALESCE(e.accredited_it_employer, false) AS accredited_it_employer,
        NULLIF(regexp_replace(COALESCE(e.rating, ''), '[^0-9\\.]', '', 'g'), '')::numeric AS rating_num,
        (COALESCE(v.salary_from, v.salary_to) + COALESCE(v.salary_to, v.salary_from)) / 2.0 AS salary_mid
    FROM public.get_vacancies v
    LEFT JOIN public.employers e ON e.name = v.employer
    WHERE (v.salary_from IS NOT NULL OR v.salary_to IS NOT NULL)
      AND v.published_at IS NOT NULL
),
factor_rows AS (
    SELECT
        professional_role,
        month_start,
        currency,
        'rating_bucket' AS factor,
        CASE
            WHEN rating_num IS NULL THEN 'unknown'
            WHEN rating_num < 3.5 THEN '<3.5'
            WHEN rating_num < 4.0 THEN '3.5-3.99'
            WHEN rating_num < 4.5 THEN '4.0-4.49'
            ELSE '>=4.5'
        END AS factor_value,
        salary_mid
    FROM base
    UNION ALL
    SELECT
        professional_role,
        month_start,
        currency,
        'accreditation' AS factor,
        CASE WHEN accredited_it_employer THEN 'true' ELSE 'false' END AS factor_value,
        salary_mid
    FROM base
    UNION ALL
    SELECT
        professional_role,
        month_start,
        currency,
        'has_test' AS factor,
        CASE WHEN has_test THEN 'true' ELSE 'false' END AS factor_value,
        salary_mid
    FROM base
    UNION ALL
    SELECT
        professional_role,
        month_start,
        currency,
        'cover_letter_required' AS factor,
        CASE WHEN response_letter_required THEN 'true' ELSE 'false' END AS factor_value,
        salary_mid
    FROM base
)
SELECT
    professional_role,
    to_char(month_start, 'YYYY-MM') AS month,
    factor,
    factor_value,
    COUNT(*) AS group_n,
    ROUND(AVG(salary_mid) FILTER (WHERE currency = 'RUR')::numeric, 2) AS avg_salary_rur,
    ROUND(AVG(salary_mid) FILTER (WHERE currency = 'USD')::numeric, 2) AS avg_salary_usd,
    ROUND(AVG(salary_mid) FILTER (WHERE currency IS NOT NULL AND currency NOT IN ('RUR', 'USD'))::numeric, 2) AS "avg_salary_%usd"
FROM factor_rows
GROUP BY professional_role, month_start, factor, factor_value
HAVING COUNT(*) >= 10
ORDER BY professional_role, month_start, factor, group_n DESC;