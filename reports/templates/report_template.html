<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Анализ вакансий по ролям - {{ current_date }}</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js" charset="utf-8"></script>
</head>
<body>
    <h1>Анализ вакансий по профессиональным ролям</h1>
    <p class="report-date">Отчёт сгенерирован: <strong>{{ current_date }}</strong></p>

    <!-- Вкладки по ролям -->
    <div class="tabs role-tabs">
        {% for role in roles %}
        <button class="tab-button role-button" onclick="openRoleTab(event, 'role-{{ loop.index }}')">{{ role.id }}</button>
        {% endfor %}
    </div>

    {% for role in roles %}
    {% set role_index = loop.index %}
    <div id="role-{{ role_index }}" class="role-content">
        <h2>{{ role.name }} (ID: {{ role.id }})</h2>

        <!-- Вкладки выбора анализа -->
        <div class="tabs analysis-tabs">
            <button class="tab-button analysis-button active" onclick="switchAnalysis(event, 'activity-{{ role_index }}')">Анализ активности по месяцам</button>
            <button class="tab-button analysis-button" onclick="switchAnalysis(event, 'weekday-{{ role_index }}')">Анализ по дням недели</button>
        </div>

        <!-- Вкладки по месяцам (для первого анализа) -->
        {% if role.months %}
        <div class="tabs month-tabs activity-month-tabs" data-analysis="activity-{{ role_index }}">
            {% for month_data in role.months %}
            <button class="tab-button month-button" onclick="openMonthTab(event, 'month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
            {% endfor %}
        </div>

        <!-- Блоки месяцев (для первого анализа) -->
        {% for month_data in role.months %}
        <div id="month-{{ role_index }}-{{ loop.index }}" class="month-content" data-analysis="activity-{{ role_index }}" style="display: none;">
            <!-- Таблица для анализа активности -->
            <div class="analysis-content activity-content">
                <table>
                    <thead>
                        <tr>
                            <th>Опыт</th>
                            <th>Всего</th>
                            <th>Архивных</th>
                            <th>Активных</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in month_data.entries %}
                        <tr {% if entry.is_max_archived %}class="max-archived"{% endif %}>
                            <td>{{ entry.experience }}</td>
                            <td>{{ entry.total }}</td>
                            <td>{{ entry.archived }}</td>
                            <td>{{ entry.active }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- График для активности -->
                <div id="chart-activity-{{ role_index }}-{{ loop.index }}" class="plotly-chart"></div>
                <script>
                    (function() {
                        var roleIdx = {{ role_index }};
                        var monthIdx = {{ loop.index }};
                        var entries = {{ month_data.entries | tojson }};
                        var experiences = entries.map(e => e.experience);
                        var active = entries.map(e => e.active);
                        var archived = entries.map(e => e.archived);
                        var total = entries.map(e => e.total);
                        var avgAge = entries.map(e => e.avg_age);

                        var traceActive = {
                            x: experiences,
                            y: active,
                            name: 'Активных',
                            type: 'bar'
                        };
                        var traceArchived = {
                            x: experiences,
                            y: archived,
                            name: 'Архивных',
                            type: 'bar'
                        };
                        var layout = {
                            title: 'Количество вакансий по опыту',
                            barmode: 'group',
                            xaxis: { title: 'Опыт' },
                            yaxis: { title: 'Количество' }
                        };
                        Plotly.newPlot('chart-activity-' + roleIdx + '-' + monthIdx, [traceActive, traceArchived], layout);
                    })();
                </script>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Блок для второго анализа (дни недели) -->
        <div class="weekday-content" data-analysis="weekday-{{ role_index }}" style="display: none;">
            {% if role.weekday_data %}
            <table>
                <thead>
                    <tr>
                        <th>День недели</th>
                        <th>Публикаций</th>
                        <th>Архиваций</th>
                        <th>Ср. время публикации</th>
                        <th>Ср. время архивации</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in role.weekday_data %}
                    <tr>
                        <td>{{ entry.weekday }}</td>
                        <td>{{ entry.total }}</td>
                        <td>{{ entry.archived }}</td>
                        <td>{{ entry.avg_publish_hour }}:00</td>
                        <td>{{ entry.avg_archive_hour }}:00</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- График для дней недели -->
            <div id="chart-weekday-{{ role_index }}" class="plotly-chart"></div>
            <script>
                (function() {
                    var roleIdx = {{ role_index }};
                    var weekdayData = {{ role.weekday_data | tojson }};
                    // Сортируем по дню недели (понедельник = 1, воскресенье = 7) — здесь простой порядок из БД, но можно отсортировать
                    var daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    var sorted = weekdayData.slice().sort((a, b) => {
                        return daysOrder.indexOf(a.weekday) - daysOrder.indexOf(b.weekday);
                    });
                    var days = sorted.map(d => d.weekday);
                    var total = sorted.map(d => d.total);
                    var archived = sorted.map(d => d.archived);

                    var traceTotal = {
                        x: days,
                        y: total,
                        name: 'Публикаций',
                        type: 'bar'
                    };
                    var traceArchived = {
                        x: days,
                        y: archived,
                        name: 'Архиваций',
                        type: 'bar'
                    };
                    var layout = {
                        title: 'Публикации и архивации по дням недели',
                        barmode: 'group',
                        xaxis: { title: 'День недели' },
                        yaxis: { title: 'Количество' }
                    };
                    Plotly.newPlot('chart-weekday-' + roleIdx, [traceTotal, traceArchived], layout);
                })();
            </script>
            {% else %}
            <p>Нет данных для анализа по дням недели.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <script>
        function openRoleTab(evt, roleId) {
            var i, roleContent, roleButtons;
            roleContent = document.getElementsByClassName("role-content");
            for (i = 0; i < roleContent.length; i++) {
                roleContent[i].style.display = "none";
            }
            roleButtons = document.getElementsByClassName("role-button");
            for (i = 0; i < roleButtons.length; i++) {
                roleButtons[i].className = roleButtons[i].className.replace(" active", "");
            }
            document.getElementById(roleId).style.display = "block";
            evt.currentTarget.className += " active";

            // Активируем первый анализ и первый месяц (если есть)
            var roleDiv = document.getElementById(roleId);
            var firstAnalysis = roleDiv.querySelector('.analysis-button');
            if (firstAnalysis) firstAnalysis.click();
        }

        function switchAnalysis(evt, analysisId) {
            var parentRole = evt.currentTarget.closest('.role-content');
            var analysisButtons = parentRole.getElementsByClassName("analysis-button");
            for (var i = 0; i < analysisButtons.length; i++) {
                analysisButtons[i].className = analysisButtons[i].className.replace(" active", "");
            }
            evt.currentTarget.className += " active";

            // Скрываем все блоки с данными (месяцы и weekday-content)
            var monthTabs = parentRole.querySelector('.activity-month-tabs');
            var monthContents = parentRole.getElementsByClassName('month-content');
            var weekdayContent = parentRole.querySelector('.weekday-content');

            if (analysisId.startsWith('activity')) {
                // Показываем вкладки месяцев и первый месяц
                if (monthTabs) monthTabs.style.display = 'flex';
                for (var mc of monthContents) {
                    if (mc.dataset.analysis === analysisId) {
                        // скрыты/показаны будут через openMonthTab, поэтому просто убедимся что первый месяц активен
                    }
                }
                if (weekdayContent) weekdayContent.style.display = 'none';

                // Активируем первую вкладку месяца
                var firstMonthButton = parentRole.querySelector('.month-button');
                if (firstMonthButton) firstMonthButton.click();
            } else {
                // Скрываем вкладки месяцев и все month-content, показываем weekday-content
                if (monthTabs) monthTabs.style.display = 'none';
                for (var mc of monthContents) {
                    mc.style.display = 'none';
                }
                if (weekdayContent) {
                    weekdayContent.style.display = 'block';
                    // Перерисовываем график на случай, если он не отображался (можно и не надо)
                }
            }
        }

        function openMonthTab(evt, monthId) {
            var i, monthContent, monthButtons;
            var parentRole = evt.currentTarget.closest('.role-content');
            monthContent = parentRole.getElementsByClassName("month-content");
            for (i = 0; i < monthContent.length; i++) {
                monthContent[i].style.display = "none";
            }
            monthButtons = parentRole.getElementsByClassName("month-button");
            for (i = 0; i < monthButtons.length; i++) {
                monthButtons[i].className = monthButtons[i].className.replace(" active", "");
            }
            document.getElementById(monthId).style.display = "block";
            evt.currentTarget.className += " active";
        }

        document.addEventListener("DOMContentLoaded", function() {
            var firstRoleButton = document.getElementsByClassName("role-button")[0];
            if (firstRoleButton) firstRoleButton.click();
        });
    </script>
</body>
</html>