<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ —Ä–æ–ª—è–º - {{ current_date }} {{ current_time }}</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script src="report.js"></script>
</head>
<body>
    <h1>–ê–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–∞ {{ current_date }} {{ current_time }}</h1>

    <!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ —Ä–æ–ª—è–º -->
    <div id="role-selector" class="role-selector">
        <div class="role-selector-header">
            <div class="role-selector-controls">
                <label class="role-multiselect">
                    <input type="checkbox" id="multi-role-toggle">
                    –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä
                </label>
                <button id="all-roles-toggle" class="role-selector-toggle" type="button" aria-pressed="false" title="–°–≤–æ–¥–Ω–æ –ø–æ –≤—Å–µ–º —Ä–æ–ª—è–º">Œ£</button>
                <button id="role-selector-toggle" class="role-selector-toggle" type="button" aria-expanded="true" aria-controls="role-selector-panel">
                    ‚ñº
                </button>
            </div>
            <div class="role-selector-choices">
                <div id="role-selected-chips" class="role-selected-chips"></div>
                <button id="role-selection-clear" class="role-selection-clear" type="button" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
            </div>
        </div>
        <div id="role-selector-panel" class="tabs role-tabs">
            {% for role in roles %}
            <button class="tab-button role-button" data-role-index="{{ loop.index }}" data-role-id="{{ role.id }}" data-role-name="{{ role.name }}">{{ role.name }}</button>
            {% endfor %}
        </div>
    </div>

    {% for role in roles %}
    {% set role_index = loop.index %}
    <div id="role-{{ role_index }}" class="role-content" data-role-id="{{ role.id }}" data-role-name="{{ role.name }}">
        <h2>{{ role.name }} [ID: {{ role.id }}]</h2>

        <!-- –í–∫–ª–∞–¥–∫–∏ –≤—ã–±–æ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞ (4) -->
        <div class="tabs analysis-tabs">
            <button class="tab-button analysis-button active"
                    data-analysis-id="activity-{{ role_index }}"
                    onclick="switchAnalysis(event, 'activity-{{ role_index }}')">–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="weekday-{{ role_index }}"
                    onclick="switchAnalysis(event, 'weekday-{{ role_index }}')">–ê–Ω–∞–ª–∏–∑ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="skills-monthly-{{ role_index }}"
                    onclick="switchAnalysis(event, 'skills-monthly-{{ role_index }}')">–ù–∞–≤—ã–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="salary-{{ role_index }}"
                    onclick="switchAnalysis(event, 'salary-{{ role_index }}')">–ê–Ω–∞–ª–∏–∑ –∑–∞—Ä–ø–ª–∞—Ç</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏) -->
        <div class="tabs month-tabs activity-only" style="justify-content: center;">
            {% for month_data in role.months %}
            <button class="tab-button month-button" onclick="openMonthTab(event, 'month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
            {% endfor %}
        </div>

        <!-- –ë–ª–æ–∫–∏ –º–µ—Å—è—Ü–µ–≤ (—Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–∞–±–ª–∏—Ü—É –∏ –≥—Ä–∞—Ñ–∏–∫) -->
        {% for month_data in role.months %}
        {% set month_index = loop.index %}
        <div id="month-{{ role_index }}-{{ month_index }}" class="month-content activity-only"
             data-entries='{{ month_data.entries | tojson }}'
             data-month="{{ month_data.month }}">
            <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div class="view-toggle-horizontal">
                <button class="view-mode-btn together-btn active" data-view="together" title="–í–º–µ—Å—Ç–µ">‚äû</button>
                <button class="view-mode-btn table-btn" data-view="table" title="–¢–∞–±–ª–∏—Ü–∞">‚ò∑</button>
                <button class="view-mode-btn graph-btn" data-view="graph" title="–ì—Ä–∞—Ñ–∏–∫">üìä</button>
            </div>
            <div class="analysis-flex view-mode-container" data-analysis="activity">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–û–ø—ã—Ç</th>
                                <th>–í—Å–µ–≥–æ</th>
                                <th>–ê—Ä—Ö–∏–≤–Ω—ã—Ö</th>
                                <th>–ê–∫—Ç–∏–≤–Ω—ã—Ö</th>
                                <th>–°—Ä. –≤–æ–∑—Ä–∞—Å—Ç (–¥–Ω–∏)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in month_data.entries %}
                            <tr {% if entry.is_max_archived %}class="max-archived"{% endif %}>
                                <td>{{ entry.experience }}</td>
                                <td>{{ entry.total }}</td>
                                <td>{{ entry.archived }}</td>
                                <td>{{ entry.active }}</td>
                                <td>{% if entry.avg_age is not none %}{{ "%.1f"|format(entry.avg_age) }}{% else %}‚Äî{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="plotly-graph" id="activity-graph-{{ role_index }}-{{ month_index }}"></div>
            </div>
        </div>
        {% endfor %}

        <!-- –ë–ª–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ -->
        {% set weekday_role = weekday_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="weekday-content" data-analysis="weekday-{{ role_index }}" style="display: none;"
             data-weekdays='{{ weekday_role.weekdays | tojson if weekday_role else "[]" }}'>
            {% if weekday_role %}
            <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ –¥–ª—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
            <div class="view-toggle-horizontal">
                <button class="view-mode-btn together-btn active" data-view="together" title="–í–º–µ—Å—Ç–µ">‚äû</button>
                <button class="view-mode-btn table-btn" data-view="table" title="–¢–∞–±–ª–∏—Ü–∞">‚ò∑</button>
                <button class="view-mode-btn graph-btn" data-view="graph" title="–ì—Ä–∞—Ñ–∏–∫">üìä</button>
            </div>
            <div class="analysis-flex view-mode-container" data-analysis="weekday">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
                                <th>–ü—É–±–ª–∏–∫–∞—Ü–∏–π</th>
                                <th>–ê—Ä—Ö–∏–≤–∞—Ü–∏–π</th>
                                <th>–°—Ä. –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</th>
                                <th>–°—Ä. –≤—Ä–µ–º—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in weekday_role.weekdays %}
                            <tr>
                                <td>{{ day.weekday }}</td>
                                <td>{{ day.publications }}</td>
                                <td>{{ day.archives }}</td>
                                <td>{{ day.avg_pub_hour }}</td>
                                <td>{{ day.avg_arch_hour }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="plotly-graph" id="weekday-graph-{{ role_index }}"></div>
            </div>
            {% else %}
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –¥–ª—è —ç—Ç–æ–π —Ä–æ–ª–∏</p>
            {% endif %}
        </div>

        <!-- –ë–ª–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–≤—ã–∫–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º -->
        {% set skills_monthly_role = skills_monthly_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="skills-monthly-content" data-analysis="skills-monthly-{{ role_index }}" style="display: none;"
             data-skills-monthly='{{ skills_monthly_role.months_list | tojson if skills_monthly_role else "[]" }}'>
            {% if skills_monthly_role and skills_monthly_role.months_list %}
                <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—Ü–∞ -->
                <div class="tabs monthly-skills-month-tabs" style="justify-content: center; margin-top: 10px;">
                    {% for month_data in skills_monthly_role.months_list %}
                    <button class="tab-button monthly-skills-month-button" onclick="openMonthlySkillsMonthTab(event, 'ms-month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
                    {% endfor %}
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ -->
                {% for month_data in skills_monthly_role.months_list %}
                {% set month_index = loop.index %}
                <div id="ms-month-{{ role_index }}-{{ month_index }}" class="monthly-skills-month-content" data-month='{{ month_data | tojson }}' style="display: none;">
                    <!-- –í–Ω—É—Ç—Ä–∏ –º–µ—Å—è—Ü–∞ - –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—ã—Ç–∞ -->
                    <div class="tabs monthly-skills-exp-tabs" style="justify-content: center; margin-top: 5px;">
                        {% for exp in month_data.experiences %}
                        <button class="tab-button monthly-skills-exp-button" onclick="openMonthlySkillsExpTab(event, 'ms-exp-{{ role_index }}-{{ month_index }}-{{ loop.index }}')">{{ exp.experience }}</button>
                        {% endfor %}
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–ø—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—è—Ü–∞ -->
                    {% for exp in month_data.experiences %}
                    {% set exp_index = loop.index %}
                    <div id="ms-exp-{{ role_index }}-{{ month_index }}-{{ exp_index }}" class="monthly-skills-exp-content" data-exp='{{ exp | tojson }}' style="display: none;">
                        <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ –¥–ª—è –Ω–∞–≤—ã–∫–æ–≤ -->
                        <div class="view-toggle-horizontal">
                            <button class="view-mode-btn together-btn active" data-view="together" title="–í–º–µ—Å—Ç–µ">‚äû</button>
                            <button class="view-mode-btn table-btn" data-view="table" title="–¢–∞–±–ª–∏—Ü–∞">‚ò∑</button>
                            <button class="view-mode-btn graph-btn" data-view="graph" title="–ì—Ä–∞—Ñ–∏–∫">üìä</button>
                        </div>
                        <div class="analysis-flex view-mode-container" data-analysis="skills-monthly">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>–ù–∞–≤—ã–∫</th>
                                            <th>–£–ø–æ–º–∏–Ω–∞–Ω–∏–π</th>
                                            <th>% –ø–æ–∫—Ä—ã—Ç–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for skill in exp.skills %}
                                        <tr>
                                            <td>{{ skill.skill }}</td>
                                            <td>{{ skill.count }}</td>
                                            <td>{{ skill.coverage }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <p style="margin-top: 10px; color: var(--text-secondary);">–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π —Å –Ω–∞–≤—ã–∫–∞–º–∏: {{ exp.total_vacancies }}</p>
                            </div>
                            <div class="plotly-graph" id="skills-monthly-graph-{{ role_index }}-{{ month_index }}-{{ exp_index }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–∞–≤—ã–∫–∞–º —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –º–µ—Å—è—Ü–∞–º –¥–ª—è —ç—Ç–æ–π —Ä–æ–ª–∏</p>
            {% endif %}
        </div>

        <!-- –ë–ª–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞—Ä–ø–ª–∞—Ç (—Å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü–∞) -->
        {% set salary_role = salary_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="salary-content" data-analysis="salary-{{ role_index }}" style="display: none;"
             data-salary='{{ salary_role.months_list | tojson if salary_role else "[]" }}'>
            {% if salary_role and salary_role.months_list %}
                <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—è—Ü–∞ -->
                <div class="tabs salary-month-tabs" style="justify-content: center; margin-top: 10px;">
                    {% for month_data in salary_role.months_list %}
                    <button class="tab-button salary-month-button" onclick="openSalaryMonthTab(event, 'sal-month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
                    {% endfor %}
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ -->
                {% for month_data in salary_role.months_list %}
                {% set month_index = loop.index %}
                <div id="sal-month-{{ role_index }}-{{ month_index }}" class="salary-month-content" data-month='{{ month_data | tojson }}' style="display: none;">
                    <!-- –í–Ω—É—Ç—Ä–∏ –º–µ—Å—è—Ü–∞ - –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—ã—Ç–∞ -->
                    <div class="tabs salary-exp-tabs" style="justify-content: center; margin-top: 5px;">
                        {% for exp in month_data.experiences %}
                        <button class="tab-button salary-exp-button" onclick="openSalaryExpTab(event, 'sal-exp-{{ role_index }}-{{ month_index }}-{{ loop.index }}')">{{ exp.experience }}</button>
                        {% endfor %}
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–ø—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—è—Ü–∞ -->
                    {% for exp in month_data.experiences %}
                    {% set exp_index = loop.index %}
                    <div id="sal-exp-{{ role_index }}-{{ month_index }}-{{ exp_index }}" class="salary-exp-content" data-exp='{{ exp | tojson }}' style="display: none;">
                        <div class="salary-display-flex" data-exp-index="{{ exp_index }}">
                            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: —Ç–∞–±–ª–∏—Ü–∞ –∏ –≥—Ä–∞—Ñ–∏–∫ -->
                            <div class="salary-main-content">
                                <div class="salary-table-container">
                                    <div style="overflow-x: auto;">
                                        <table id="salary-table-{{ role_index }}-{{ month_index }}-{{ exp_index }}">
                                            <thead>
                                                <tr>
                                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                                    <th>–í–∞–ª—é—Ç–∞</th>
                                                    <th>–í—Å–µ–≥–æ</th>
                                                    <th>–° –∑/–ø</th>
                                                    <th>% —Å –∑/–ø</th>
                                                    <th>–°—Ä–µ–¥–Ω—è—è</th>
                                                    <th>–ú–µ–¥–∏–∞–Ω–Ω–∞—è</th>
                                                    <th>–ú–æ–¥–∞–ª—å–Ω–∞—è</th>
                                                    <th>–ú–∏–Ω</th>
                                                    <th>–ú–∞–∫—Å</th>
                                                    <!-- —Å—Ç–æ–ª–±–µ—Ü "–†–∞–∑–º–∞—Ö" —É–¥–∞–ª—ë–Ω -->
                                                    <th>–¢–æ–ø-10 –Ω–∞–≤—ã–∫–æ–≤</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for entry in exp.entries %}
                                                <tr class="salary-row"
                                                    data-vacancy-ids='{{ entry.vacancy_ids | tojson }}'
                                                    data-vacancies-with='{{ entry.vacancies_with_salary_list | tojson }}'
                                                    data-vacancies-without='{{ entry.vacancies_without_salary_list | tojson }}'>
                                                    <td>{{ entry.status }}</td>
                                                    <td>{{ entry.currency }}</td>
                                                    <td>{{ entry.total_vacancies }}</td>
                                                    <td>{{ entry.vacancies_with_salary }}</td>
                                                    <td>{{ entry.salary_percentage }}%</td>
                                                    <td>{{ "{:,.0f}".format(entry.avg_salary) }}</td>
                                                    <td>{% if entry.median_salary is not none %}{{ "{:,.0f}".format(entry.median_salary) }}{% else %}‚Äî{% endif %}</td>
                                                    <td>{% if entry.mode_salary is not none %}{{ "{:,.0f}".format(entry.mode_salary) }}{% else %}‚Äî{% endif %}</td>
                                                    <td>{{ "{:,.0f}".format(entry.min_salary) }}</td>
                                                    <td>{{ "{:,.0f}".format(entry.max_salary) }}</td>
                                                    <td>{{ entry.top_skills }}</td>
                                                </tr>
                                                <tr class="vacancy-details" style="display: none;">
                                                    <td colspan="11">
                                                        <div class="vacancy-details-container"></div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="salary-graph-container">
                                    <div class="plotly-graph" id="salary-graph-{{ role_index }}-{{ month_index }}-{{ exp_index }}"></div>
                                </div>
                            </div>
                            <!-- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
                            <div class="salary-view-toggle">
                                <button class="view-mode-btn" data-view="together" title="–í–º–µ—Å—Ç–µ">‚äû</button>
                                <button class="view-mode-btn active" data-view="table" title="–¢–∞–±–ª–∏—Ü–∞">‚ò∑</button>
                                <button class="view-mode-btn" data-view="graph" title="–ì—Ä–∞—Ñ–∏–∫">üìä</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º –¥–ª—è —ç—Ç–æ–π —Ä–æ–ª–∏</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div id="role-combined" class="role-content" style="display: none;"></div>
    <div id="role-all" class="role-content" style="display: none;"></div>

    <div id="vacancy-modal-backdrop" class="vacancy-modal-backdrop" style="display: none;">
        <div class="vacancy-modal" role="dialog" aria-modal="true" aria-labelledby="vacancy-modal-title">
            <div class="vacancy-modal-header">
                <div id="vacancy-modal-title" class="vacancy-modal-title">–í–∞–∫–∞–Ω—Å–∏–∏</div>
                <button type="button" class="vacancy-modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>
            <div id="vacancy-modal-context" class="vacancy-modal-context"></div>
            <div id="vacancy-modal-body" class="vacancy-modal-body"></div>
        </div>
    </div>
</body>
</html>
