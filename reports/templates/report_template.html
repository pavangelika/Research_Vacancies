<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Анализ вакансий по ролям - {{ current_date }} {{ current_time }}</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script src="report.js"></script>
</head>
<body>
    <h1>Анализ вакансий на {{ current_date }} {{ current_time }}</h1>

    <!-- Вкладки по ролям -->
    <div class="tabs role-tabs">
        {% for role in roles %}
        <button class="tab-button role-button" onclick="openRoleTab(event, 'role-{{ loop.index }}')">{{ role.id }}</button>
        {% endfor %}
    </div>

    {% for role in roles %}
    {% set role_index = loop.index %}
    <div id="role-{{ role_index }}" class="role-content">
        <h2>{{ role.name }} [ID: {{ role.id }}]</h2>

        <!-- Вкладки выбора анализа (4) -->
        <div class="tabs analysis-tabs">
            <button class="tab-button analysis-button active"
                    data-analysis-id="activity-{{ role_index }}"
                    onclick="switchAnalysis(event, 'activity-{{ role_index }}')">Анализ активности</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="weekday-{{ role_index }}"
                    onclick="switchAnalysis(event, 'weekday-{{ role_index }}')">Анализ по дням недели</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="skills-monthly-{{ role_index }}"
                    onclick="switchAnalysis(event, 'skills-monthly-{{ role_index }}')">Навыки по месяцам</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="salary-{{ role_index }}"
                    onclick="switchAnalysis(event, 'salary-{{ role_index }}')">Анализ зарплат</button>
        </div>

        <!-- Вкладки по месяцам (только для анализа активности) -->
        <div class="tabs month-tabs activity-only" style="justify-content: center;">
            {% for month_data in role.months %}
            <button class="tab-button month-button" onclick="openMonthTab(event, 'month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
            {% endfor %}
        </div>

        <!-- Блоки месяцев (содержат таблицу и график) -->
        {% for month_data in role.months %}
        {% set month_index = loop.index %}
        <div id="month-{{ role_index }}-{{ month_index }}" class="month-content activity-only"
             data-entries='{{ month_data.entries | tojson }}'
             data-month="{{ month_data.month }}">
            <div class="analysis-flex">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Опыт</th>
                                <th>Всего</th>
                                <th>Архивных</th>
                                <th>Активных</th>
                                <th>Ср. возраст (дни)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in month_data.entries %}
                            <tr {% if entry.is_max_archived %}class="max-archived"{% endif %}>
                                <td>{{ entry.experience }}</td>
                                <td>{{ entry.total }}</td>
                                <td>{{ entry.archived }}</td>
                                <td>{{ entry.active }}</td>
                                <td>{{ "%.1f"|format(entry.avg_age) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="plotly-graph" id="activity-graph-{{ role_index }}-{{ month_index }}"></div>
            </div>
        </div>
        {% endfor %}

        <!-- Блок для анализа по дням недели -->
        {% set weekday_role = weekday_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="weekday-content" data-analysis="weekday-{{ role_index }}" style="display: none;"
             data-weekdays='{{ weekday_role.weekdays | tojson if weekday_role else "[]" }}'>
            {% if weekday_role %}
            <div class="analysis-flex">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>День недели</th>
                                <th>Публикаций</th>
                                <th>Архиваций</th>
                                <th>Ср. время публикации</th>
                                <th>Ср. время архивации</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in weekday_role.weekdays %}
                            <tr>
                                <td>{{ day.weekday }}</td>
                                <td>{{ day.publications }}</td>
                                <td>{{ day.archives }}</td>
                                <td>{{ day.avg_pub_hour }}</td>
                                <td>{{ day.avg_arch_hour }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="plotly-graph" id="weekday-graph-{{ role_index }}"></div>
            </div>
            {% else %}
            <p>Нет данных по дням недели для этой роли</p>
            {% endif %}
        </div>

        <!-- Блок для анализа навыков по месяцам -->
        {% set skills_monthly_role = skills_monthly_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="skills-monthly-content" data-analysis="skills-monthly-{{ role_index }}" style="display: none;"
             data-skills-monthly='{{ skills_monthly_role.months_list | tojson if skills_monthly_role else "[]" }}'>
            {% if skills_monthly_role and skills_monthly_role.months_list %}
                <!-- Вкладки для выбора месяца -->
                <div class="tabs monthly-skills-month-tabs" style="justify-content: center; margin-top: 10px;">
                    {% for month_data in skills_monthly_role.months_list %}
                    <button class="tab-button monthly-skills-month-button" onclick="openMonthlySkillsMonthTab(event, 'ms-month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
                    {% endfor %}
                </div>

                <!-- Контейнеры для каждого месяца -->
                {% for month_data in skills_monthly_role.months_list %}
                {% set month_index = loop.index %}
                <div id="ms-month-{{ role_index }}-{{ month_index }}" class="monthly-skills-month-content" data-month='{{ month_data | tojson }}' style="display: none;">
                    <!-- Внутри месяца - вкладки для выбора опыта -->
                    <div class="tabs monthly-skills-exp-tabs" style="justify-content: center; margin-top: 5px;">
                        {% for exp in month_data.experiences %}
                        <button class="tab-button monthly-skills-exp-button" onclick="openMonthlySkillsExpTab(event, 'ms-exp-{{ role_index }}-{{ month_index }}-{{ loop.index }}')">{{ exp.experience }}</button>
                        {% endfor %}
                    </div>

                    <!-- Контейнеры для каждого опыта внутри месяца -->
                    {% for exp in month_data.experiences %}
                    {% set exp_index = loop.index %}
                    <div id="ms-exp-{{ role_index }}-{{ month_index }}-{{ exp_index }}" class="monthly-skills-exp-content" data-exp='{{ exp | tojson }}' style="display: none;">
                        <div class="analysis-flex">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Навык</th>
                                            <th>Упоминаний</th>
                                            <th>% покрытия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for skill in exp.skills %}
                                        <tr>
                                            <td>{{ skill.skill }}</td>
                                            <td>{{ skill.count }}</td>
                                            <td>{{ skill.coverage }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <p style="margin-top: 10px; color: var(--ios-dark-gray);">Всего вакансий с навыками: {{ exp.total_vacancies }}</p>
                            </div>
                            <div class="plotly-graph" id="skills-monthly-graph-{{ role_index }}-{{ month_index }}-{{ exp_index }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <p>Нет данных по навыкам с разбивкой по месяцам для этой роли</p>
            {% endif %}
        </div>

        <!-- Блок для анализа зарплат (обновлённый) -->
        {% set salary_role = salary_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="salary-content" data-analysis="salary-{{ role_index }}" style="display: none;"
             data-salary='{{ salary_role.months_list | tojson if salary_role else "[]" }}'>
            {% if salary_role and salary_role.months_list %}
                <!-- Переключатель режимов отображения -->
                <div class="tabs view-mode-tabs" style="justify-content: center; margin-bottom: 10px;">
                    <button class="tab-button view-mode-button active" data-view="together">Вместе</button>
                    <button class="tab-button view-mode-button" data-view="table">Таблица</button>
                    <button class="tab-button view-mode-button" data-view="graph">График</button>
                </div>

                <!-- Вкладки для выбора месяца -->
                <div class="tabs salary-month-tabs" style="justify-content: center; margin-top: 10px;">
                    {% for month_data in salary_role.months_list %}
                    <button class="tab-button salary-month-button" onclick="openSalaryMonthTab(event, 'sal-month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
                    {% endfor %}
                </div>

                <!-- Контейнеры для каждого месяца -->
                {% for month_data in salary_role.months_list %}
                {% set month_index = loop.index %}
                <div id="sal-month-{{ role_index }}-{{ month_index }}" class="salary-month-content" data-month='{{ month_data | tojson }}' style="display: none;">
                    <!-- Внутри месяца - вкладки для выбора опыта -->
                    <div class="tabs salary-exp-tabs" style="justify-content: center; margin-top: 5px;">
                        {% for exp in month_data.experiences %}
                        <button class="tab-button salary-exp-button" onclick="openSalaryExpTab(event, 'sal-exp-{{ role_index }}-{{ month_index }}-{{ loop.index }}')">{{ exp.experience }}</button>
                        {% endfor %}
                    </div>

                    <!-- Контейнеры для каждого опыта внутри месяца -->
                    {% for exp in month_data.experiences %}
                    {% set exp_index = loop.index %}
                    <div id="sal-exp-{{ role_index }}-{{ month_index }}-{{ exp_index }}" class="salary-exp-content" data-exp='{{ exp | tojson }}' style="display: none;">
                        <div class="salary-display-flex" data-exp-index="{{ exp_index }}">
                            <div class="salary-table-container">
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Статус</th>
                                                <th>Валюта</th>
                                                <th>Всего</th>
                                                <th>С з/п</th>
                                                <th>% с з/п</th>
                                                <th>Средняя</th>
                                                <th>Медианная</th>
                                                <th>Модальная</th>
                                                <th>Мин</th>
                                                <th>Макс</th>
                                                <th>Размах</th>
                                                <th>Топ-5 навыков</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for entry in exp.entries %}
                                            <tr>
                                                <td>{{ entry.status }}</td>
                                                <td>{{ entry.currency }}</td>
                                                <td>{{ entry.total_vacancies }}</td>
                                                <td>{{ entry.vacancies_with_salary }}</td>
                                                <td>{{ entry.salary_percentage }}%</td>
                                                <td>{{ "{:,.0f}".format(entry.avg_salary) }}</td>
                                                <td>{% if entry.median_salary is not none %}{{ "{:,.0f}".format(entry.median_salary) }}{% else %}—{% endif %}</td>
                                                <td>{% if entry.mode_salary is not none %}{{ "{:,.0f}".format(entry.mode_salary) }}{% else %}—{% endif %}</td>
                                                <td>{{ "{:,.0f}".format(entry.min_salary) }}</td>
                                                <td>{{ "{:,.0f}".format(entry.max_salary) }}</td>
                                                <td>{{ "{:,.0f}".format(entry.salary_range) }}</td>
                                                <td>{{ entry.top_skills }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="salary-graph-container">
                                <div class="plotly-graph" id="salary-graph-{{ role_index }}-{{ month_index }}-{{ exp_index }}"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <p>Нет данных по зарплатам для этой роли</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</body>
</html>