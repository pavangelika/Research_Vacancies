<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Анализ вакансий по ролям - {{ current_date }} {{ current_time }}</title>
    <link rel="stylesheet" href="styles.css?v=20260301v">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script src="report.state.js?v=20260301v"></script>
    <script src="report.utils.js?v=20260301v"></script>
    <script src="report.data.js?v=20260301v"></script>
    <script src="report.charts.js?v=20260301v"></script>
    <script src="report.render.js?v=20260301v"></script>
    <script src="report.ui.js?v=20260301v"></script>
    <script src="report.events.js?v=20260301v"></script>
</head>
<body>
    <h1>Анализ вакансий на {{ current_date }} {{ current_time }}</h1>

    <!-- Вкладки по ролям -->
    <div id="role-selector" class="role-selector"></div>

    {% for role in roles %}
    {% set role_index = loop.index %}
    <div id="role-{{ role_index }}" class="role-content" data-role-id="{{ role.id }}" data-role-name="{{ role.name }}"
         data-vacancies='{{ role.vacancies | tojson if role.vacancies else "[]" }}'>
        <h2>{{ role.name }} [ID: {{ role.id }}]</h2>

        <!-- Вкладки выбора анализа (4) -->
        <div class="tabs analysis-tabs">
            <button class="tab-button analysis-button active"
                    data-analysis-id="activity-{{ role_index }}"
                    onclick="switchAnalysis(event, 'activity-{{ role_index }}')">Анализ активности</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="weekday-{{ role_index }}"
                    onclick="switchAnalysis(event, 'weekday-{{ role_index }}')">Анализ по дням недели</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="skills-monthly-{{ role_index }}"
                    onclick="switchAnalysis(event, 'skills-monthly-{{ role_index }}')">Топ-навыки</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="skills-search-{{ role_index }}"
                    onclick="switchAnalysis(event, 'skills-search-{{ role_index }}')">&#1055;&#1086;&#1080;&#1089;&#1082; &#1087;&#1086; &#1085;&#1072;&#1074;&#1099;&#1082;&#1072;&#1084;</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="salary-{{ role_index }}"
                    onclick="switchAnalysis(event, 'salary-{{ role_index }}')">Анализ зарплат</button>
            <button class="tab-button analysis-button"
                    data-analysis-id="employer-analysis-{{ role_index }}"
                    onclick="switchAnalysis(event, 'employer-analysis-{{ role_index }}')">Анализ работодателей</button>
            <button class="tab-button summary-report-btn" type="button">Сводный отчет</button>
        </div>

        <!-- Вкладки по месяцам (только для анализа активности) -->
        <div class="tabs month-tabs activity-only" style="justify-content: center;">
            {% for month_data in role.months %}
            <button class="tab-button month-button" onclick="openMonthTab(event, 'month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
            {% endfor %}
        </div>

        <!-- Блоки месяцев (содержат таблицу и график) -->
        {% for month_data in role.months %}
        {% set month_index = loop.index %}
        <div id="month-{{ role_index }}-{{ month_index }}" class="month-content activity-only"
             data-entries='{{ month_data.entries | tojson }}'
             data-month="{{ month_data.month }}">
            <!-- Горизонтальный переключатель режимов для активности -->
            <div class="view-toggle-horizontal">
                <button class="view-mode-btn together-btn active" data-view="together" title="Вместе">⊞</button>
                <button class="view-mode-btn table-btn" data-view="table" title="Таблица">☷</button>
                <button class="view-mode-btn graph-btn" data-view="graph" title="График">📊</button>
            </div>
            <div class="analysis-flex view-mode-container" data-analysis="activity">
                <div class="table-container"></div>
                <div class="plotly-graph" id="activity-graph-{{ role_index }}-{{ month_index }}"></div>
            </div>
        </div>
        {% endfor %}

        <!-- Блок для анализа по дням недели -->
        {% set weekday_role = weekday_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="weekday-content" data-analysis="weekday-{{ role_index }}" style="display: none;"
             data-weekdays='{{ weekday_role.weekdays | tojson if weekday_role else "[]" }}'>
            {% if weekday_role %}
            <!-- Горизонтальный переключатель режимов для дней недели -->
            <div class="view-toggle-horizontal">
                <button class="view-mode-btn together-btn active" data-view="together" title="Вместе">⊞</button>
                <button class="view-mode-btn table-btn" data-view="table" title="Таблица">☷</button>
                <button class="view-mode-btn graph-btn" data-view="graph" title="График">📊</button>
            </div>
            <div class="analysis-flex view-mode-container" data-analysis="weekday">
                <div class="table-container"></div>
                <div class="plotly-graph" id="weekday-graph-{{ role_index }}"></div>
            </div>
            {% else %}
            <p>Нет данных по дням недели для этой роли</p>
            {% endif %}
        </div>

        <!-- Блок для анализа навыков по месяцам -->
        {% set skills_monthly_role = skills_monthly_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="skills-monthly-content" data-analysis="skills-monthly-{{ role_index }}" style="display: none;"
             data-skills-monthly='{{ skills_monthly_role.months_list | tojson if skills_monthly_role else "[]" }}'>
            {% if skills_monthly_role and skills_monthly_role.months_list %}
                <!-- Вкладки для выбора месяца -->
                <div class="tabs monthly-skills-month-tabs" style="justify-content: center; margin-top: 10px;">
                    {% for month_data in skills_monthly_role.months_list %}
                    <button class="tab-button monthly-skills-month-button" onclick="openMonthlySkillsMonthTab(event, 'ms-month-{{ role_index }}-{{ loop.index }}')">{{ month_data.month }}</button>
                    {% endfor %}
                </div>

                <!-- Контейнеры для каждого месяца -->
                {% for month_data in skills_monthly_role.months_list %}
                {% set month_index = loop.index %}
                <div id="ms-month-{{ role_index }}-{{ month_index }}" class="monthly-skills-month-content" data-month='{{ month_data | tojson }}' style="display: none;">
                    <!-- Внутри месяца - вкладки для выбора опыта -->
                    <div class="tabs monthly-skills-exp-tabs" style="justify-content: center; margin-top: 5px;">
                        {% for exp in month_data.experiences %}
                        <button class="tab-button monthly-skills-exp-button" onclick="openMonthlySkillsExpTab(event, 'ms-exp-{{ role_index }}-{{ month_index }}-{{ loop.index }}')">{{ exp.experience }}</button>
                        {% endfor %}
                        <label class="skills-multi-toggle">
                            <input type="checkbox" class="skills-multi-toggle-input"> Мультивыбор
                        </label>
                    </div>

                    <!-- Контейнеры для каждого опыта внутри месяца -->
                    {% for exp in month_data.experiences %}
                    {% set exp_index = loop.index %}
                    <div id="ms-exp-{{ role_index }}-{{ month_index }}-{{ exp_index }}" class="monthly-skills-exp-content" data-exp='{{ exp | tojson }}' style="display: none;">
                        <!-- Горизонтальный переключатель режимов для навыков -->
                        <div class="view-toggle-horizontal">
                            <button class="view-mode-btn together-btn active" data-view="together" title="Вместе">⊞</button>
                            <button class="view-mode-btn table-btn" data-view="table" title="Таблица">☷</button>
                            <button class="view-mode-btn graph-btn" data-view="graph" title="График">📊</button>
                        </div>
                        <div class="analysis-flex view-mode-container" data-analysis="skills-monthly">
                            <div class="table-container"></div>
                            <div class="plotly-graph" id="skills-monthly-graph-{{ role_index }}-{{ month_index }}-{{ exp_index }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <p>Нет данных по навыкам с разбивкой по месяцам для этой роли</p>
            {% endif %}
        </div>

        <!-- Блок для анализа зарплат (с вертикальным переключателем, по умолчанию таблица) -->
        {% set salary_role = salary_roles | selectattr('id', 'equalto', role.id) | first %}
        <!-- ???? ??? ?????? ???&#1055;&#1086;&#1080;&#1089;&#1082; &#1087;&#1086; &#1085;&#1072;&#1074;&#1099;&#1082;&#1072;&#1084; -->
                                <!-- ???? ??? ?????? ???????? ?? ??????? -->
        <div class="skills-search-content" data-analysis="skills-search-{{ role_index }}" style="display: none;">
                                    <div class="skills-search-panel">
                <div class="skills-search-panel-header">
                    <div class="skills-search-summary-line"></div>
                    <button class="skills-search-toggle" type="button" aria-expanded="true">&#9650;</button>
                    <button class="skills-search-select-all" type="button">&#1042;&#1099;&#1073;&#1088;&#1072;&#1090;&#1100; &#1074;&#1089;&#1077;</button>
                    <button class="skills-search-reset-skills" type="button">&#1057;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100; &#1085;&#1072;&#1074;&#1099;&#1082;&#1080;</button>
                    <div class="skills-search-dropdown skills-search-logic-inline" data-filter="logic">
                        <button class="skills-search-dropdown-btn" type="button" data-value="or">??????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown skills-search-sort-inline" data-filter="sort">
                        <button class="skills-search-dropdown-btn" type="button" data-value="count">??????????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown" data-filter="period">
                        <button class="skills-search-dropdown-btn" type="button" data-value="all">??????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown" data-filter="exp" data-multi="1">
                        <button class="skills-search-dropdown-btn" type="button" data-value="all">????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown" data-filter="status">
                        <button class="skills-search-dropdown-btn" type="button" data-value="all">??????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown" data-filter="currency" data-multi="1">
                        <button class="skills-search-dropdown-btn" type="button" data-value="all">??????</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <div class="skills-search-dropdown" data-filter="country">
                        <button class="skills-search-dropdown-btn" type="button" data-value="all">&#1057;&#1090;&#1088;&#1072;&#1085;&#1072;</button>
                        <div class="skills-search-dropdown-menu"></div>
                    </div>
                    <button class="skills-search-clear" type="button">&#10005;</button>
                </div>
                <div class="skills-search-buttons"></div>
            </div>
            <div class="skills-search-results">
                <div class="skills-search-hint">&#1042;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1085;&#1072;&#1074;&#1099;&#1082;&#1080;, &#1095;&#1090;&#1086;&#1073;&#1099; &#1091;&#1074;&#1080;&#1076;&#1077;&#1090;&#1100; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;</div>
            </div>
        </div>

        <div class="salary-content" data-analysis="salary-{{ role_index }}" style="display: none;" data-salary="[]"></div>

        {% set employer_analysis_role = employer_analysis_roles | selectattr('id', 'equalto', role.id) | first %}
        <div class="employer-analysis-content" data-analysis="employer-analysis-{{ role_index }}" style="display: none;">
            {% if employer_analysis_role and employer_analysis_role.rows %}
            <div class="employer-topbar">
                <div class="tabs month-tabs employer-period-chips" style="justify-content: center; margin: 8px 0;">
                    <button type="button" class="tab-button month-button employer-period-chip active" data-month="all">За период</button>
                </div>
                <div class="employer-view-toggle employer-side-toggle">
                    <button class="view-mode-btn employer-view-btn active" data-view="table" title="Таблица">☷</button>
                    <button class="view-mode-btn employer-view-btn" data-view="graph" title="График">📈</button>
                </div>
            </div>
            <div class="analysis-flex employer-analysis-view" style="justify-content: center; align-items: flex-start;">
                <div class="employer-analysis-main">
                    <div class="table-container employer-analysis-table-container" style="margin: 0 auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Месяц</th>
                                    <th>Фактор</th>
                                    <th>Значение фактора</th>
                                    <th>Количество</th>
                                    <th>Средняя зарплата, RUR</th>
                                    <th>Средняя зарплата, USD</th>
                                    <th>Средняя зарплата, EUR</th>
                                    <th>Средняя зарплата, Другая валюта</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in employer_analysis_role.rows %}
                                <tr class="employer-analysis-row"
                                    data-month="{{ row.month }}"
                                    data-factor="{{ row.factor }}"
                                    data-factor-value="{{ row.factor_value }}"
                                    data-group-n="{{ row.group_n }}"
                                    data-avg-rur-n="{{ row.avg_salary_rur_n }}"
                                    data-avg-rur="{{ row.avg_salary_rur if row.avg_salary_rur is not none else '' }}"
                                    data-avg-usd-n="{{ row.avg_salary_usd_n }}"
                                    data-avg-usd="{{ row.avg_salary_usd if row.avg_salary_usd is not none else '' }}"
                                    data-avg-eur-n="{{ row.avg_salary_eur_n }}"
                                    data-avg-eur="{{ row.avg_salary_eur if row.avg_salary_eur is not none else '' }}"
                                    data-avg-other-n="{{ row.avg_salary_other_n }}"
                                    data-avg-other="{{ row.avg_salary_other if row.avg_salary_other is not none else '' }}">
                                    <td>{{ row.month }}</td>
                                    <td>
                                        {% if row.factor == 'accreditation' or row.factor == '' %}ИТ-аккредитация
                                        {% elif row.factor == 'cover_letter_required' %}Сопроводительное письмо
                                        {% elif row.factor == 'has_test' %}Тестовое задание
                                        {% elif row.factor == 'rating_bucket' %}Рейтинг фирмы
                                        {% else %}{{ row.factor }}{% endif %}
                                    </td>
                                    <td class="employer-factor-value-cell" data-raw-value="{{ row.factor_value }}">
                                        {% if row.factor_value == 'true' %}<span class="bool-check bool-true" aria-label="Да"></span>
                                        {% elif row.factor_value == 'false' %}<span class="bool-check bool-false" aria-label="Нет"></span>
                                        {% elif row.factor == 'rating_bucket' and row.factor_value == 'unknown' %}нет рейтинга
                                        {% else %}{{ row.factor_value }}{% endif %}
                                    </td>
                                    <td>{{ row.group_n }}</td>
                                    <td>{{ "{:,.2f}".format(row.avg_salary_rur) if row.avg_salary_rur is not none else "—" }}</td>
                                    <td>{{ "{:,.2f}".format(row.avg_salary_usd) if row.avg_salary_usd is not none else "—" }}</td>
                                    <td>{{ "{:,.2f}".format(row.avg_salary_eur) if row.avg_salary_eur is not none else "—" }}</td>
                                    <td>{{ "{:,.2f}".format(row.avg_salary_other) if row.avg_salary_other is not none else "—" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="plotly-graph employer-analysis-graph" id="employer-analysis-graph-{{ role_index }}" style="display: none;"></div>
                </div>
            </div>
            {% else %}
            <p>Нет данных анализа работодателей для этой роли</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <div id="role-combined" class="role-content" style="display: none;"></div>
    <div id="role-all" class="role-content" style="display: none;"></div>

    <div id="vacancy-modal-backdrop" class="vacancy-modal-backdrop" style="display: none;">
        <div class="vacancy-modal" role="dialog" aria-modal="true" aria-labelledby="vacancy-modal-title">
            <div class="vacancy-modal-header">
                <div id="vacancy-modal-title" class="vacancy-modal-title">Вакансии</div>
                <button type="button" class="vacancy-modal-close" aria-label="Закрыть">×</button>
            </div>
            <div id="vacancy-modal-context" class="vacancy-modal-context"></div>
            <div id="vacancy-modal-body" class="vacancy-modal-body"></div>
        </div>
    </div>

    <div id="employer-modal-backdrop" class="employer-modal-backdrop" style="display: none;">
        <div class="employer-modal" role="dialog" aria-modal="true" aria-labelledby="employer-modal-title">
            <div class="employer-modal-header">
                <div id="employer-modal-title" class="employer-modal-title">&#1056;&#1072;&#1073;&#1086;&#1090;&#1086;&#1076;&#1072;&#1090;&#1077;&#1083;&#1100;</div>
                <button type="button" class="employer-modal-close" aria-label="&#1047;&#1072;&#1082;&#1088;&#1099;&#1090;&#1100;">&#215;</button>
            </div>
            <div id="employer-modal-body" class="employer-modal-body"></div>
        </div>
    </div>
</body>
</html>





